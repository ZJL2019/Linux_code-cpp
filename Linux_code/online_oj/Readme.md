

项目名称：在线OJ

一、项目介绍
	仿照LeetCode实现一个模拟的在线OJ项目，通过多个模块之间的相互工作，实现用户在浏览器提交代码后，服务器对提交信息进行处理和返回结果的一个过程。

​	为什么做这个项目：在最近找实习的过程中，个人认为需要一个能拿的出手的网络项目，同时为了准备笔试经常在牛客和Leetcode刷题，所以自然而然想到了能否实现一个简单的在线OJ项目。

二、使用技术

http
TCP协议
boost库
Lambda表达式
ctemplate库

三、项目流程

客户端：
		

![](./批注 2020-03-20 124527.jpg)

细分需求：

1. 在浏览器当中展示题目（oj_server,试题模块）
2. 客户可以选择题目进行作答（oj_server，试题模块）
3. 提交代码到后台（oj_server）
4. 针对客户端提交的代码，进行编译（编译运行模块）
5. 后台运行可执行程序（编译运行模块）
6. 对结果进行打包（编译运行模块）
7. 将结果返回给客户端（oj_server）

OJ_server流程：

1. 通过提交http://ip:端口/all_questions进入在线OJ主界面
   1. 其主界面显示所有试题的  试题id    试题名称     试题难度
2. 点击任意试题名称通过提交http://ip:端口/question/id来获取对应单个题目的信息
   1. 通过正则表达式匹配id
   2. 然后进行数据获取
   3. 通过数据进行html渲染
3. 用户在代码框中进行作答，然后提交给服务器
   1. 通过POST进行表单提交
   2. 服务器对body进行url解码
   3. 进行程序编译和运行
4. 服务器通过对编译结果和运行结果进行响应组织
   1. 返回给浏览器最终程序的结果

四、模块划分

![](./批注 2020-03-20 124425.jpg)

五、模块功能

1. oj_server模块
   1. 提供http服务，串联试题模块和编译运行模块
      1. 获取题目列表
      2. 提供选中的题目
      3. 提供题目初始代码和题目描述信息以及代码编译框
      4. 提供最终代码编译的结果和运行结果
2. 试题模块
   1. 从配置文件当中加载题目
      1. 配置文件格式
         1. 约定配置文件当中对题目描述的格式
         2. 题目的编号（id），题目的名称，题目所在的目录（在目录中存放对应的题目描述），题目难度
            eg: 1    回文数    ./oj_data/1    简单
      2. 加载题目的配置文件，使用数据结构保存加载出来的题目介绍信息，注意：题目路径一定要正确
      3. 针对每一道题目而言需要根据给出的路径进行加载
         1. desc.txt:题目的描述信息
         2. header.cpp:存放的是该题目所包含的头文件以及实现类代码
         3. tail.cpp:存放测试用例以及main函数的入口
   2. 提供获取整体题目的接口
      1. 给oj_server模块提供一个可以获取所有题目的接口，展示给用户
   3. 提供获取单个题目的接口
      1. 给oj_server模块提供一个可以获取单个题目描述和作答的接口
   4. 渲染html页面
      1. 使用ctemplate进行主页面的html模板渲染
      2. 通过获取到对应的题目描述信息和预加载代码，来渲染单个问题界面
      3. 通过编译的结果和运行结果，来渲染最终代码提交后的结果
3. 编译运行模块：将用户提交的代码写到文件中去，编译源码文件，编译成为可执行程序，并且运行
   1. 编译
      1. 将用户提交的代码写入文件当中
      2. fork()子进程进行进程程序替换为g++程序，进行编译源码文件
      3. 获取编译结果写到标准输出文件当中或者写入到标准错误文件当中
   2. 运行
      1. 如果代码走到运行阶段，说明一定编译出来了可执行程序，fork子进程，让子进程进行进程程序替换，替换成为编译出来的可执行程序
      2. 将程序的运行结果，保存到标准输出文件或者标准错误文件当中去
      3. 然后通过读取文件将所有的数据组织到对应的json格式中
4. 工具模块
   1. 提供时间戳服务
      1. 为了区分不同用户提交的代码，当代码写到文件当中去的时候，使用时间戳来进行区分
      2. 提供年月日时间戳，用来记录日志模块的日志时间信息
   2. 提供写文件操作
      1. 将编译结果，运行结果写入对应的文件中
      2. 将最终组织好的用户代码写入到tmp_时间戳.cpp的文件中
   3. 提供读文件操作
      1. 需要提供对一行数据进行切割的接口
      2. 通过试题模块的单个试题信息加载方法，来读取其对应的试题描述信息和预加载代码
      3. 读取标准错误文，标准输出文件中的文件内容
   4. 提供URL解码操作
   5. 自行扩展的部分工具操作
5. 日志模块
   1. 时间戳转换年月日作为标量信息
   2. 用来记录当前程序所执行过程中的状态和提交信息
   3. "INFO","WARNING","ERROR","FATAL","DEBUG",日志信息级别
   4. 使用logfile.log来记录日志信息

六、项目问题

1. 前端页面显示风格较差
2. 在正则表达式匹配id时如何匹配后面所有字符，以及防止转义字符的二义性
3. 程序替换时采用fork(),不能采用线程
4. 如何区分是哪一个用户提交的代码
5. 如果数据过多，使用文件存储效率低
6. 如何将编译的结果和运行结果返回给浏览器

七、改进方案

1. 可以设计更好看的前端界面
2. 采用R("")的方式避免转义字符的二义性
3. 因为线程会替换当前oj进程中的数据段和代码段
4. 采用时间戳命名文件
5. 采用数据库对题目文件，编译结果等数据的存储
6. 通过读取对应文件中的数据，进行对应的json格式的组织，通过json格式获取数据，然后渲染最终的响应界面



